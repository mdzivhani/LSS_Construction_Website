services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leetshego-nginx
    restart: unless-stopped
    ports:
      - "9080:80"   # HTTP for leetshego.co.za
      - "9443:443"  # HTTPS for leetshego.co.za
    volumes:
      - /home/mulalo/logs/lss_construction:/var/log/nginx
      - /etc/letsencrypt:/etc/letsencrypt:ro
    networks:
      - leetshego-network
    # Temporarily disable dependency on quote-api until SMTP credentials are provided
    healthcheck:
      # Busybox wget inside alpine nginx image: use 127.0.0.1 to bypass hostname server selection
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # quote-api:
  #   build:
  #     context: ./server/quote-api
  #     dockerfile: Dockerfile
  #   container_name: leetshego-quote-api
  #   restart: unless-stopped
  #   environment:
  #     - PORT=3000
  #     - SMTP_HOST=${SMTP_HOST}
  #     - SMTP_PORT=${SMTP_PORT}
  #     - SMTP_SECURE=${SMTP_SECURE}
  #     - SMTP_USER=${SMTP_USER}
  #     - SMTP_PASS=${SMTP_PASS}
  #     - FROM_EMAIL=${FROM_EMAIL}
  #     - TO_EMAIL=${TO_EMAIL}
  #   networks:
  #     - leetshego-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s

networks:
  leetshego-network:
    driver: bridge
