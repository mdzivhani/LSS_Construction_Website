name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [dev]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run build and test
        run: |
          echo "Starting CI checks..."
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: leetshego-construction:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install test dependencies
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard
      
      - name: Validate HTML
        run: |
          htmlhint "*.html" || echo "HTML validation completed"
      
      - name: Verify required files
        run: |
          required_files=(
            "index.html"
            "about.html"
            "services.html"
            "projects.html"
            "contact.html"
            "Dockerfile"
            "docker-compose.yml"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file missing - $file"
              exit 1
            fi
          done
          
          echo "✓ All required files present"
      
      - name: Verify Docker Compose
        run: |
          docker compose -f docker-compose.yml config > /dev/null
          echo "✓ Docker Compose configuration valid"
      
      - name: Create CI summary
        if: always()
        run: |
          echo "## CI Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ HTML validation completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Required files verified" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker Compose configuration validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for merge to main branch**" >> $GITHUB_STEP_SUMMARY
